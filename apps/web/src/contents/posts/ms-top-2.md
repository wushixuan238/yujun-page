---
title: "Microservice(äºŒ)ï¼šæ·±å…¥ç†è§£äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼"
category: "Software Development"
publishedAt: "2025-06-06"
summary: "SD"  
tags:  
  - Microservice
banner: /images/banner/posts/microservice/ms-top-02.png
alt: "å›¾ç‰‡æ›¿ä»£æ–‡æœ¬"  
mathjax: false
---


# æ·±å…¥ç†è§£äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼ï¼šç‰¢ç‰¢æŠŠæ¡ä½æ¯ä¸€æ¡æ¶ˆæ¯

åœ¨æ„å»ºå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨å®Œæˆä¸€ä¸ªä¸šåŠ¡æ“ä½œï¼ˆæ¯”å¦‚åœ¨æ•°æ®åº“ä¸‹å• ğŸ›’ï¼‰ä¹‹åï¼Œé€šçŸ¥å…¶ä»–ç³»ç»Ÿæˆ–è€…æ¨¡å—æ‰§è¡Œåç»­ä»»åŠ¡ï¼ˆæ¯”å¦‚å‘é€é‚®ä»¶ ğŸ“§ï¼Œæ›´æ–°ç¼“å­˜ ğŸ”„ï¼‰ã€‚ä¸€ä¸ªå¸¸è§çš„åšæ³•æ˜¯ï¼Œåœ¨ä¸šåŠ¡æ“ä½œçš„åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç›´æ¥è°ƒç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰çš„å‘é€æ¥å£ã€‚

å¬èµ·æ¥å¾ˆç›´æ¥ï¼Œå¾ˆç®€å•ï¼ŒğŸ¤” ä½†æ˜¯ï¼Œè¿™é‡Œéšè—ç€ä¸€ä¸ªç»å…¸çš„åˆ†å¸ƒå¼éš¾é¢˜ï¼š**æ•°æ®åº“æ“ä½œå’ŒMQå‘é€æ“ä½œï¼Œå®ƒä»¬ä¸å±äºåŒä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨ï¼Œå¦‚ä½•ä¿è¯è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§å‘¢ï¼Ÿ**

è¿™å¯èƒ½å¯¼è‡´ä»¥ä¸‹æƒ…å†µï¼š

* æ•°æ®åº“æ“ä½œæˆåŠŸäº† ğŸ‘ï¼Œä½†MQå‘é€å¤±è´¥äº† âŒï¼ˆç½‘ç»œé—®é¢˜ã€MQæŒ‚äº†ï¼‰ã€‚ç»“æœï¼šä¸šåŠ¡å®Œæˆäº†ï¼Œä½†ä¸‹æ¸¸çš„é€šçŸ¥ä¸¢äº†ï¼ŒçŸ³æ²‰å¤§æµ· ğŸŒŠã€‚
* MQå‘é€æˆåŠŸäº† ğŸ‘ï¼Œä½†æ•°æ®åº“æ“ä½œå¤±è´¥å›æ»šäº† âŒã€‚ç»“æœï¼šä¸‹æ¸¸æ”¶åˆ°äº†ä¸€ä¸ªâ€œå¹½çµâ€æ¶ˆæ¯ ğŸ‘»ï¼Œå¯¹åº”çš„ä¸šåŠ¡æ•°æ®å¯èƒ½æ ¹æœ¬ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸ä¸€è‡´ã€‚

è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œæ˜¯æˆ‘ä»¬æåŠ›å¸Œæœ›é¿å…çš„ã€‚ä¼ ç»Ÿçš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¦‚XAã€TCCï¼‰è™½ç„¶èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†å®ƒä»¬å¼•å…¥çš„å¤æ‚åº¦å’Œæ€§èƒ½å¼€é”€å¾€å¾€è®©äººæœ›è€Œå´æ­¥ ğŸ˜«ã€‚

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ›´è½»é‡ã€æ›´å¯é çš„æ–¹å¼å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦éš†é‡ä»‹ç»çš„ä¸»è§’â€”â€” **äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼ (Transactional Outbox Pattern)** ã€‚

## ç†è®ºå…ˆè¡Œï¼šä»€ä¹ˆæ˜¯äº‹åŠ¡å‘ä»¶ç®±æ¨¡å¼ï¼Ÿ

äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼æ˜¯ä¸€ç§é€šè¿‡**æœ¬åœ°æ•°æ®åº“äº‹åŠ¡**æ¥ä¿è¯â€œä¸šåŠ¡æ“ä½œâ€å’Œâ€œå‘é€æ¶ˆæ¯çš„æ„å›¾â€åŸå­æ€§æ‰§è¡Œçš„ä¸€ç§ç²¾å¦™è®¾è®¡ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

* **å¼•å…¥â€œå‘ä»¶ç®±â€è¡¨** ğŸ—³ï¸ï¼šåœ¨ä¸ä¸šåŠ¡æ•°æ®ç›¸åŒçš„æ•°æ®åº“ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªé¢å¤–çš„è¡¨ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå‘ä»¶ç®±è¡¨â€ï¼ˆOutbox Tableï¼‰ã€‚è¿™å¼ è¡¨ä¸“é—¨ç”¨æ¥å­˜å‚¨é‚£äº›**å°†è¦è¢«å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯**ã€‚
* **åŸå­å†™å…¥** âœï¸ï¼šå½“æ‰§è¡Œä¸€ä¸ªéœ€è¦å‘å¸ƒäº‹ä»¶çš„ä¸šåŠ¡æ“ä½œæ—¶ï¼Œåœ¨**åŒä¸€ä¸ªæœ¬åœ°æ•°æ®åº“äº‹åŠ¡**ä¸­ï¼ŒåŒæ—¶å®Œæˆä»¥ä¸‹ä¸¤ä»¶äº‹ï¼š
  1. å¯¹ä¸šåŠ¡æ•°æ®è¡¨è¿›è¡Œå¢åˆ æ”¹æ“ä½œã€‚
  2. å‘â€œå‘ä»¶ç®±è¡¨â€æ’å…¥ä¸€æ¡è®°å½•ï¼Œè¿™æ¡è®°å½•ä»£è¡¨äº†è¦å‘é€çš„MQæ¶ˆæ¯ï¼ˆåŒ…å«æ¶ˆæ¯å†…å®¹ã€ç›®æ ‡ä¸»é¢˜ã€çŠ¶æ€ç­‰ï¼‰ã€‚
* **ç‹¬ç«‹çš„â€œæ¶ˆæ¯ä¸­ç»§â€æœåŠ¡** ğŸš€ï¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æˆ–çº¿ç¨‹ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ¶ˆæ¯ä¸­ç»§â€æˆ–â€œäº‹ä»¶å‘å¸ƒå™¨â€ï¼‰ï¼Œå®ƒä¼šå®šæœŸæˆ–å®æ—¶åœ°è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š
  1. è½®è¯¢â€œå‘ä»¶ç®±è¡¨â€ï¼ŒæŸ¥æ‰¾é‚£äº›çŠ¶æ€ä¸ºâ€œå¾…å‘é€â€çš„æ¶ˆæ¯ã€‚
  2. å°†è¿™äº›æ¶ˆæ¯å‘å¸ƒåˆ°çœŸæ­£çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚RabbitMQ, Kafkaï¼‰ã€‚
  3. æ¶ˆæ¯æˆåŠŸå‘å¸ƒåˆ°MQåï¼Œæ›´æ–°â€œå‘ä»¶ç®±è¡¨â€ä¸­å¯¹åº”è®°å½•çš„çŠ¶æ€ä¸ºâ€œå·²å‘é€â€ï¼Œæˆ–è€…ç›´æ¥åˆ é™¤è¯¥è®°å½•ã€‚

**ä¸ºä»€ä¹ˆè¿™æ ·åšèƒ½ä¿è¯å¯é æ€§ï¼Ÿ**

1. **åŸå­æ€§ä¿è¯** ï¼šæ ¸å¿ƒä¸šåŠ¡æ“ä½œå’Œâ€œè®°å½•è¦å‘é€çš„æ¶ˆæ¯â€è¢«ç»‘å®šåœ¨åŒä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ä¸­ã€‚æ•°æ®åº“çš„ACIDç‰¹æ€§å°±ä¼šä¿è¯å®ƒä»¬è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚è¿™æ ·å°±é¿å…äº†â€œä¸šåŠ¡æˆåŠŸä½†æ¶ˆæ¯æ„å›¾ä¸¢å¤±â€ï¼Œæˆ–è€…â€œæ¶ˆæ¯å‘é€çš„æ„å›¾è®°å½•ä½†ä¸šåŠ¡æ“ä½œå¤±è´¥â€çš„æƒ…å†µã€‚
2. **æŒä¹…åŒ–ä¿éšœ** ï¼šå³ä½¿åº”ç”¨ç¨‹åºåœ¨äº‹åŠ¡æäº¤åã€æ¶ˆæ¯ä¸­ç»§æœåŠ¡å‘é€æ¶ˆæ¯å‰ä¸å¹¸å´©æºƒ ğŸ’¥ï¼Œç”±äºæ¶ˆæ¯æ„å›¾å·²ç»æŒä¹…åŒ–åœ¨å‘ä»¶ç®±è¡¨ä¸­ï¼Œå½“ä¸­ç»§æœåŠ¡æ¢å¤æˆ–åº”ç”¨é‡å¯åï¼Œå®ƒä»ç„¶å¯ä»¥ä»å‘ä»¶ç®±ä¸­æ‰¾åˆ°æœªå‘é€çš„æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚
3. **è§£è€¦æ¸…æ™°** ï¼šä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œä¸æ¶ˆæ¯çš„å®é™…å‘é€æ˜¯è§£è€¦çš„ã€‚ä¸šåŠ¡ä»£ç ä¸éœ€è¦å…³å¿ƒMQæ˜¯å¦å¯ç”¨æˆ–å‘é€æ˜¯å¦ç«‹å³æˆåŠŸï¼Œå¯ä»¥â€œå‘å°„åä¸ç®¡â€ï¼ˆfire-and-forgetï¼Œä½†å®é™…ä¸Šæˆ‘ä»¬ç®¡äº† ğŸ˜‰ï¼‰ã€‚

**æ²¡æœ‰ç»å¯¹çš„é“¶å¼¹ï¼Œé‚£ä¹ˆè¿™æ ·åšæœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿ** âš–ï¸

* **æ¶ˆæ¯å»¶è¿Ÿ** ï¼šæ¶ˆæ¯çš„å®é™…å‘é€ä¼šæ¯”ä¸šåŠ¡æ“ä½œå®Œæˆæ™šä¸€æ­¥ï¼ˆå› ä¸ºéœ€è¦ä¸­ç»§æœåŠ¡è½®è¯¢æˆ–è§¦å‘ï¼‰ã€‚
* **æ•°æ®åº“é¢å¤–è´Ÿè½½** ï¼šå¢åŠ äº†å¯¹å‘ä»¶ç®±è¡¨çš„è¯»å†™æ“ä½œï¼Œå¯èƒ½ä¼šå¯¹æ•°æ®åº“é€ æˆä¸€å®šçš„å‹åŠ›ã€‚
* **å®ç°æ¶ˆæ¯ä¸­ç»§æœåŠ¡çš„æˆæœ¬** ï¼šéœ€è¦é¢å¤–å®ç°è¿™ä¸ªæ¶ˆæ¯ä¸­ç»§æœåŠ¡ï¼Œå¹¶ä¸”è¿™ä¸ªæœåŠ¡éœ€è¦ä¿è¯è‡ªèº«çš„å¥å£®æ€§å’Œå¹‚ç­‰æ€§ï¼ˆé˜²æ­¢é‡å¤å‘é€ï¼‰ã€‚

## åŠ¨æ‰‹å®è·µï¼šä»¥ç”¨æˆ·ä¸­å¥–è®°å½•ä¿å­˜ä¸å‘å¥–é€šçŸ¥ä¸ºä¾‹ ğŸ

### åœ¨DBä¸­åˆ›å»º`task`è¡¨ï¼šå……å½“â€œå‘ä»¶ç®±â€

```java
@Data
public class Task {
    private String id;          // è‡ªå¢ID (å®é™…å¯èƒ½æ˜¯UUIDæˆ–ä¸šåŠ¡ID)
    private String userId;      // å…³è”çš„ç”¨æˆ·ID
    private String topic;       // æ¶ˆæ¯ä¸»é¢˜ (å¯¹åº”MQçš„Topic/Exchange)
    private String messageId;   // æ¶ˆæ¯ç¼–å· (MQæ¶ˆæ¯çš„å”¯ä¸€ID)
    private String message;     // æ¶ˆæ¯ä¸»ä½“ (JSONåºåˆ—åŒ–åçš„æ¶ˆæ¯å†…å®¹)
    private String state;       // ä»»åŠ¡çŠ¶æ€ï¼›create-åˆ›å»ºã€completed-å®Œæˆã€fail-å¤±è´¥
    private Date createTime;
    private Date updateTime;
}
```

### ç¼–å†™ä¸šåŠ¡æ–¹æ³•ï¼š`saveUserAwardRecord`

```java
@Override
public void saveUserAwardRecord(UserAwardRecordAggregate userAwardRecordAggregate) {

    UserAwardRecordEntity userAwardRecordEntity = userAwardRecordAggregate.getUserAwardRecordEntity(); // ä¸šåŠ¡å®ä½“
    TaskEntity taskEntity = userAwardRecordAggregate.getTaskEntity(); // æ¶ˆæ¯ä»»åŠ¡å®ä½“
    String userId = userAwardRecordEntity.getUserId();
    // ... (å…¶ä»–å˜é‡è·å–)

    // 1. å°†ä¸šåŠ¡å®ä½“å’Œæ¶ˆæ¯ä»»åŠ¡å®ä½“è½¬æ¢ä¸ºæ•°æ®åº“POJO
    UserAwardRecord userAwardRecord = new UserAwardRecord(); // ä¸­å¥–è®°å½•PO
    // ... (userAwardRecord å±æ€§èµ‹å€¼)
    userAwardRecord.setAwardState(userAwardRecordEntity.getAwardState().getCode()); // åˆå§‹çŠ¶æ€ï¼Œå¦‚ "create" (å¾…å‘å¥–)

    Task task = new Task(); // å‘ä»¶ç®±ä»»åŠ¡PO
    task.setUserId(taskEntity.getUserId());
    task.setTopic(taskEntity.getTopic());
    task.setMessageId(taskEntity.getMessageId());
    task.setMessage(JSON.toJSONString(taskEntity.getMessage())); // åºåˆ—åŒ–åçš„MQæ¶ˆæ¯å†…å®¹
    task.setState(taskEntity.getState().getCode()); // åˆå§‹çŠ¶æ€ï¼Œå¦‚ "create" (å¾…å‘é€)

    UserRaffleOrder userRaffleOrderReq = new UserRaffleOrder(); // ç”¨äºæ›´æ–°æŠ½å¥–è®¢å•çŠ¶æ€çš„PO
    // ... (userRaffleOrderReq å±æ€§èµ‹å€¼)

    try {
        dbRouter.doRouter(userId); // å¦‚æœæœ‰åˆ†åº“åˆ†è¡¨ï¼Œè·¯ç”±åˆ°æ­£ç¡®çš„åº“

        // 2. ã€æ ¸å¿ƒã€‘ä½¿ç”¨ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œä¿è¯ä¸šåŠ¡æ•°æ®å†™å…¥å’ŒTaskè®°å½•å†™å…¥çš„åŸå­æ€§
        transactionTemplate.execute(status -> {
            try {
                // a. å†™å…¥ä¸­å¥–è®°å½• (ä¸šåŠ¡æ•°æ®)
                userAwardRecordDao.insert(userAwardRecord);
                // b. å†™å…¥MQä»»åŠ¡è®°å½•åˆ°taskè¡¨ (å‘ä»¶ç®±æ•°æ®)
                taskDao.insert(task);
                // c. æ›´æ–°æŠ½å¥–è®¢å•çŠ¶æ€ (å…¶ä»–ç›¸å…³ä¸šåŠ¡æ•°æ®)
                int count = userRaffleOrderDao.updateUserRaffleOrderStateUsed(userRaffleOrderReq);
                if (1 != count) { // æ ¡éªŒæ˜¯å¦æˆåŠŸæ›´æ–°ï¼Œé˜²æ­¢é‡å¤æŠ½å¥–ç­‰
                    status.setRollbackOnly();
                    log.error("å†™å…¥ä¸­å¥–è®°å½•ï¼Œç”¨æˆ·æŠ½å¥–å•å·²ä½¿ç”¨è¿‡ï¼Œä¸å¯é‡å¤æŠ½å¥– userId: {} ...", userId); // å®é™…é¡¹ç›®ä¸­å¡«å……å®Œæ•´æ—¥å¿—
                    throw new AppException(ResponseCode.ACTIVITY_ORDER_ERROR.getCode(), "ç”¨æˆ·æŠ½å¥–å•å·²ä½¿ç”¨"); // ä¸¾ä¾‹
                }
                return 1;
            } catch (DuplicateKeyException e) { // å¤„ç†å”¯ä¸€ç´¢å¼•å†²çªç­‰DBå¼‚å¸¸
                status.setRollbackOnly();
                log.error("å†™å…¥ä¸­å¥–è®°å½•ï¼Œå”¯ä¸€ç´¢å¼•å†²çª userId: {} ...", userId); // å®é™…é¡¹ç›®ä¸­å¡«å……å®Œæ•´æ—¥å¿—
                throw new AppException(ResponseCode.INDEX_DUP.getCode(), e);
            }
        });
    } finally {
        dbRouter.clear(); // æ¸…ç†åˆ†åº“åˆ†è¡¨è·¯ç”±ä¿¡æ¯
    }

    // 3. ã€ä¼˜åŒ–ã€‘äº‹åŠ¡æˆåŠŸæäº¤åï¼Œç«‹å³å°è¯•å‘é€ä¸€æ¬¡MQæ¶ˆæ¯ (æé«˜å®æ—¶æ€§)
    try {
        eventPublisher.publish(task.getTopic(), task.getMessage()); // è°ƒç”¨MQå‘é€å·¥å…·ç±»
        // å¦‚æœå‘é€æˆåŠŸï¼Œæ›´æ–°taskè¡¨ä¸­çš„çŠ¶æ€ä¸º "completed"
        taskDao.updateTaskSendMessageCompleted(task);
        log.info("å†™å…¥ä¸­å¥–è®°å½•ï¼Œå‘é€MQæ¶ˆæ¯å®Œæˆ userId: {} ...", userId); // å®é™…é¡¹ç›®ä¸­å¡«å……å®Œæ•´æ—¥å¿—
    } catch (Exception e) {
        log.error("å†™å…¥ä¸­å¥–è®°å½•ï¼Œå‘é€MQæ¶ˆæ¯å¤±è´¥ userId: {} ...", userId); // å®é™…é¡¹ç›®ä¸­å¡«å……å®Œæ•´æ—¥å¿—
        // å¦‚æœå‘é€å¤±è´¥ï¼Œæ›´æ–°taskè¡¨ä¸­çš„çŠ¶æ€ä¸º "fail" (æˆ–ä¿æŒ "create"ï¼Œç­‰å¾…å®šæ—¶ä»»åŠ¡è¡¥å¿)
        taskDao.updateTaskSendMessageFail(task);
    }
}
```

ä¸ºäº†è®©æ¶ˆæ¯å°½å¿«é€è¾¾ ğŸš€ï¼Œåœ¨æ•°æ®åº“äº‹åŠ¡æˆåŠŸæäº¤åï¼Œæˆ‘ä»¬ä¼š**ç«‹å³å°è¯•**è°ƒç”¨ `eventPublisher.publish` æ¥å‘é€MQæ¶ˆæ¯ã€‚

* å¦‚æœè¿™æ¬¡å‘é€æˆåŠŸ ğŸ‰ï¼Œ`task` è¡¨ä¸­å¯¹åº”è®°å½•çš„çŠ¶æ€ä¼šæ›´æ–°ä¸º `completed`ã€‚
* å¦‚æœè¿™æ¬¡å‘é€å¤±è´¥ ğŸ˜¥ï¼ˆæ¯”å¦‚ç½‘ç»œç¬æ–­ï¼‰ï¼Œ`task` è¡¨çš„çŠ¶æ€ä¼šæ›´æ–°ä¸º `fail`ã€‚ä½†è¯·æ³¨æ„ï¼Œå³ä½¿è¿™é‡Œæ›´æ–°çŠ¶æ€å¤±è´¥ï¼Œç”±äºTaskè®°å½•ï¼ˆçŠ¶æ€ä¸º`create`æˆ–æœªæˆåŠŸæ›´æ–°ä¸º`completed`ï¼‰å·²ç»åœ¨DBä¸­ï¼Œåç»­çš„è¡¥å¿æœºåˆ¶ä¾ç„¶ä¼šç”Ÿæ•ˆã€‚æˆ‘ä»¬æœ‰åå¤‡å†›ï¼ğŸ’ª

### â€œæ¶ˆæ¯ä¸­ç»§â€æœåŠ¡ï¼š`SendMessageTaskJob.java`

æˆ‘ä»¬è¿™é‡Œä½¿ç”¨Springçš„å®šæ—¶ä»»åŠ¡ (`@Scheduled`)ï¼Œå®ƒä¼šå®šæœŸï¼ˆæ¯”å¦‚æ¯5ç§’ï¼‰â€œå·¡é€»â€ï¼š

```java
@Slf4j
@Component()
public class SendMessageTaskJob {

    @Resource
    private ITaskService taskService; // å†…éƒ¨ä¼šè°ƒç”¨ ITaskDao
    @Resource
    private IDBRouterStrategy dbRouter; // å¤„ç†åˆ†åº“åˆ†è¡¨

    @Scheduled(cron = "0/5 * * * * ?") // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡æ£€æŸ¥
    public void exec_db01() { // ç¤ºä¾‹ï¼šå¤„ç†ç¬¬ä¸€ä¸ªåº“çš„ä»»åŠ¡
        try {
            dbRouter.setDBKey(1);
            dbRouter.setTBKey(0);

            // a. ä»taskè¡¨æŸ¥è¯¢çŠ¶æ€ä¸æ˜¯ "completed" çš„ä»»åŠ¡
            List<TaskEntity> taskEntities = taskService.queryNoSendMessageTaskList();
            if (taskEntities.isEmpty()) return; // æ²¡æœ‰ä»»åŠ¡ï¼Œä¼‘æ¯ä¸€ä¸‹ â˜•

            // b. éå†è¿™äº›å¾…å¤„ç†çš„ä»»åŠ¡
            for (TaskEntity taskEntity : taskEntities) {
                try {
                    // c. å°è¯•é‡æ–°å‘é€MQæ¶ˆæ¯
                    taskService.sendMessage(taskEntity); // å†…éƒ¨è°ƒç”¨ eventPublisher
                    // d. å¦‚æœå‘é€æˆåŠŸï¼Œæ›´æ–°taskè¡¨çŠ¶æ€ä¸º "completed"
                    taskService.updateTaskSendMessageCompleted(taskEntity.getUserId(), taskEntity.getMessageId());
                } catch (Exception e) {
                    log.error("å®šæ—¶ä»»åŠ¡ï¼Œå‘é€MQæ¶ˆæ¯å¤±è´¥ userId: {} topic: {}", taskEntity.getUserId(), taskEntity.getTopic());
                    // e. å¦‚æœä»ç„¶å¤±è´¥ï¼Œæ›´æ–°taskè¡¨çŠ¶æ€ä¸º "fail" (æˆ–è€…å¢åŠ é‡è¯•æ¬¡æ•°å­—æ®µï¼Œè¾¾åˆ°ä¸Šé™åæ ‡è®°ä¸ºfail)
                    taskService.updateTaskSendMessageFail(taskEntity.getUserId(), taskEntity.getMessageId());
                }
            }
        } catch (Exception e) {
            log.error("å®šæ—¶ä»»åŠ¡ï¼Œæ‰«æMQä»»åŠ¡è¡¨å‘é€æ¶ˆæ¯å¤±è´¥ã€‚", e);
        } finally {
            dbRouter.clear();
        }
    }
    // å¯èƒ½è¿˜æœ‰ exec_db02() ç­‰æ–¹æ³•å¤„ç†å…¶ä»–åˆ†åº“çš„ä»»åŠ¡
}
```

è¿™ä¸ªå®šæ—¶ä»»åŠ¡å°±æ˜¯äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼ä¸­çš„â€œæ¶ˆæ¯ä¸­ç»§â€è§’è‰²ã€‚å®ƒå®šæœŸä»`task`è¡¨ä¸­æå–é‚£äº›â€œåˆ›å»ºäº†ä½†æœªæˆåŠŸå‘é€â€æˆ–â€œä¸Šæ¬¡å‘é€å¤±è´¥â€çš„æ¶ˆæ¯ä»»åŠ¡ï¼Œç„¶åå°è¯•å°†è¿™äº›æ¶ˆæ¯é‡æ–°å‘é€åˆ°MQï¼Œå¹¶æ ¹æ®å‘é€ç»“æœæ›´æ–°`task`è¡¨çš„çŠ¶æ€ã€‚

ä¹‹åï¼Œä¸€äº›**æ¶ˆæ¯æ¶ˆè´¹è€…**ä¼šæ ¹æ®MQä¸Šçš„æ¶ˆæ¯ï¼Œæ¥**æ‰§è¡Œå®é™…çš„å‘å¥–æ“ä½œ**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯ç§¯åˆ†å¥–å“ ï¼Œå¯èƒ½ä¼šè°ƒç”¨ç§¯åˆ†æœåŠ¡å¢åŠ ç”¨æˆ·ç§¯åˆ†ï¼Œå¹¶æ›´æ–°ç”¨æˆ·ä¸­å¥–è®°å½•çš„çŠ¶æ€ä¸ºâ€œå·²å®Œæˆâ€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·ä¸­å¥–äº†ï¼Œæˆ‘ä»¬ä¸ç›´æ¥åœ¨ä¸»æµç¨‹é‡Œç»™ä»–å‘å¥–ï¼ˆè¿™å¯èƒ½å¾ˆæ…¢ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡MQå¼‚æ­¥è°ƒç”¨å…¶ä»–æœåŠ¡æ¥æ‰§è¡Œå‘å¥–ç­‰å¤æ‚æ“ä½œã€‚è¿™æ ·å°±æé«˜äº†ä¸»æ¥å£çš„ä¸€ä¸ªå“åº”æ—¶é—´ï¼Œç”¨æˆ·ä½“éªŒup upï¼ğŸ’¨

é™¤äº†ä¸Šè¿°çš„å‘å¥–é€šçŸ¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿™ç§æ¨¡å¼åº”ç”¨äºï¼š

* **è¡Œä¸ºè¿”åˆ©** ğŸš¶â€â™€ï¸â¡ï¸ğŸï¼šç”¨æˆ·å®Œæˆç­¾åˆ°ç­‰è¡Œä¸ºåï¼Œè®°å½•è¿”åˆ©è®¢å•å’Œå‘é€è¿”åˆ©MQçš„Taskã€‚
* **ç§¯åˆ†è°ƒæ•´** ğŸ“ˆğŸ“‰ï¼šç”¨æˆ·ç§¯åˆ†è´¦æˆ·å‘ç”Ÿå˜åŠ¨åï¼Œè®°å½•ç§¯åˆ†æµæ°´å’Œå‘é€ç§¯åˆ†è°ƒæ•´æˆåŠŸMQçš„Taskã€‚

## æ€»ç»“ ğŸ

é€šè¿‡å°†â€œå‘ä»¶ç®±â€çš„èŒè´£èµ‹äºˆé€šç”¨çš„ `task` è¡¨ï¼Œå¹¶ç»“åˆâ€œ**äº‹åŠ¡å†…è®°å½•æ„å›¾ + äº‹åŠ¡åå³æ—¶å°è¯• + åå°å®šæ—¶è¡¥å¿**â€çš„ç­–ç•¥ï¼Œéå¸¸ä¼˜é›…ä¸”å¯é åœ°è§£å†³äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸šåŠ¡æ“ä½œä¸MQæ¶ˆæ¯å‘é€çš„åŸå­æ€§é—®é¢˜ã€‚

è¿™ç§æ¨¡å¼è™½ç„¶å¼•å…¥äº†é¢å¤–çš„`task`è¡¨å’Œå®šæ—¶ä»»åŠ¡ï¼Œå¢åŠ äº†ä¸€äº›å¤æ‚æ€§ï¼Œä½†å®ƒæ¢æ¥çš„æ˜¯ç³»ç»Ÿæ¶ˆæ¯ä¼ é€’çš„**å¼ºå¯é æ€§** ğŸ’ªï¼Œè¿™åœ¨è®¸å¤šä¸šåŠ¡åœºæ™¯ä¸­æ˜¯éå¸¸å€¼å¾—çš„ã€‚å®ƒä¹Ÿæ˜¯åœ¨ä¸ä½¿ç”¨é‡é‡çº§åˆ†å¸ƒå¼äº‹åŠ¡æƒ…å†µä¸‹ï¼Œå®ç°â€œå‡†äº‹åŠ¡â€æ•ˆæœçš„å¸¸ç”¨ä¸”æœ‰æ•ˆçš„æ‰‹æ®µã€‚


---
